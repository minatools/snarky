load("@rules_foreign_cc//tools/build_defs:configure.bzl", "configure_make")

configure_make(
    name = "libgmp",
    # configure_env_vars = dict(
    #     CXXFLAGS = "-std=c++14",
    # ),
    configure_env_vars =select({
        "//bzl/host:macos": {"AR": "",
                             "CXXFLAGS": "-std=c++14"},
        "//conditions:default": {"LD": "-Wl,-S -Wl,-z,relro,-z,now"},
    }),
    #     # cross-compile:
    #     # "CPPFLAGS": "-P -fPIC -I$COSYSROOT/usr/local/include -I$COSYSROOT/usr/include",
    #     # "LDFLAGS": "-L$COSYSROOT/usr/lib/x86_64-unknown-linux-gnu",
    # ],
    ## workaround: omission of -Dredacted results in:
    ## error: invalid suffix on literal; C++11 requires a space
    ## between literal and identifier [-Wreserved-user-defined-literal]
    configure_options = select({
        "//bzl/host:linux_x64": [
            "--build=x86_64-apple-darwin",
            "--host=x86_64-unknown-linux-gnu",
            # "--prefix=" + COSYSROOT + "/usr/local",
            # "--with-sysroot=" + COSYSROOT + "/x86_64-unknown-linux-gnu/sysroot",
            "--enable-shared",
            "--enable-static",
            "--with-pic",
            "--with-gnu-ld",
        ],
        "//bzl/host:macos": [
            # "AR=\"\"",
            # # "-Wl,-no_pie" # avoid PIE disabled warning
        ],
        "//conditions:default": [],
    }) + [
        "--enable-cxx",
        "CXXFLAGS=\"-std=c++14 -lstdc++ -Wno-reserved-user-defined-literal\"",
        "CFLAGS=-Dredacted"
    ],
    lib_source = "@libgmp//:all",
    out_lib_dir = "lib",
    shared_libraries = select({
        "//bzl/host:macos": ["libgmp.dylib"], # .so works on macos, but will not build here
        "//bzl/host:linux": [
            "libgmp.so",
            "libgmpx.so",
        ],
        "//conditions:default": ["libgmp.so"],
    }),
    # trouble on macos: illegal text-relocation error
    # possible fix: add -read_only_relocs suppress to link flags
    # src: https://stackoverflow.com/questions/11317637/linker-error-when-unit-testing-ld-illegal-text-relocation-to-cstring-in-fr
    # https://stackoverflow.com/questions/6650178/illegal-text-reloc-to-non-lazy-ptr-error-while-building-in-xcode-4-with-libav-l
    
    # static_libraries = [
    #     "libgmpxx.a",
    #     "libgmp.a",
    # ],
    visibility = ["//visibility:public"],
)
