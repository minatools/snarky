load(
    "@obazl_rules_ocaml//ocaml:build.bzl",
    "ocaml_archive",
    "ocaml_executable",
    "ocaml_interface",
    "ocaml_module",
    "ocaml_ns_module",
)

COMMON_OPTS = select({
    "//bzl/config:enable_verbose": ["-verbose"],
    "//conditions:default": [],
}) + ["-warn-error",  "-27-26-32-33", "-thread"]

LINK_OPTS = select({
    "//bzl/config:always_link": ["-linkall"],
    "//conditions:default": [],
}) + []

EXEC_OPTS = COMMON_OPTS + LINK_OPTS + []
IMPL_OPTS = COMMON_OPTS + LINK_OPTS + []
INTF_OPTS = COMMON_OPTS + LINK_OPTS + []
ARCHIVE_OPTS = COMMON_OPTS + LINK_OPTS + []
COMMON_DEPS = []

## (pps ppx_jane ppx_deriving.enum))
PPX = "@//ppx/exe:ppx2_jane_enum"
PPX_BIN_OPTS = [
    # do not sort (buildifier)
    "-cookie",
    "library-name=\"election\"",
    "-corrected-suffix",
    ".ppx-corrected"
]

ocaml_executable(
    name = "election",
    opts = IMPL_OPTS + [
        # "-ccopt", "-static",
        "-cclib", "-Wl,-E",
        "-cclib", "-lsnark_caml",
        "-cclib", "-g",
        "-cclib", "-lstdc++",
        "-ccopt", "-Wl,--push-state,-Bstatic",
        "-cclib", "-lsodium",
        "-ccopt", "-Wl,--pop-state",
        # "-ccopt", "-Wl,--push-state",
        # "-cclib", "-Wl,-E",
        # "-cclib", "-lsnarky_c_strings",
        # "-ccopt", "-Wl,--pop-state",
    ],
    visibility = ["//visibility:public"],
    deps = [
        # do not sort (buildifier)
        "@opam//pkg:core_kernel",
        "//src:snarky",
        ":impl.cm_",
        ":knapsack_hash.cm_",
        ":import.cm_",
        ":election.cm_",
        ":election_main.cm_",
    ],
    cc_deps = {
        "@libff//libff/common/default_types": "default",
        "@libff//libff/common:logging": "default",
        "@libff//libff/common:profiling": "default",
        "@libff//libff/common:utils": "default",
        "@libff//libff/algebra/curves/bn128": "default",
        # "@libff//libff/algebra/curves/bn128:public_params": "default",
        "@libff//libff/algebra/curves/alt_bn128": "default",
        "@libff//libff/algebra/curves/alt_bn128:public_params": "default",
        "@libff//libff/algebra/curves/edwards": "default",
        "@libff//libff/algebra/curves/mnt": "default",
        "@libff//libff/algebra/curves/mnt/mnt4": "default",
        "@libff//libff/algebra/curves/mnt/mnt4:public_params": "default",
        "@libff//libff/algebra/curves/mnt/mnt6": "default",
        "@libff//libff/algebra/curves/mnt/mnt6:public_params": "default",
        "@libff//libff/algebra/curves/mnt753": "default",
        "@libff//libff/algebra/curves/mnt753/mnt4753": "default",
        "@libff//libff/algebra/curves/mnt753/mnt4753:public_params": "default",
        "@libff//libff/algebra/curves/mnt753/mnt6753": "default",
        "@libff//libff/algebra/curves/mnt753/mnt6753:public_params": "default",
        "@libff//libff/algebra/fields:bigint": "default",

        "@libsnark//caml:snark_caml": "default",
        # "@libsnark//caml:strings": "default",
        "@libsnark//caml:vectors": "default",
        "@libsnark//libsnark/common/data_structures": "default",
        "@libsnark//libsnark/gadgetlib1": "default",
        "@libsnark//libsnark/gadgetlib1/gadgets/hashes/sha256": "default",
        "@libsnark//libsnark/gadgetlib2": "default",
        "@libsnark//libsnark/reductions/r1cs_to_qap": "default",
        "@libsnark//libsnark/relations": "default",
        "@libsnark//libsnark/relations/circuit_satisfaction_problems/tbcs": "default",
        "@libsnark//libsnark/relations/ram_computations/memory": "default",
        "@libsnark//libsnark/relations/ram_computations/rams/fooram": "default",
        "@libsnark//libsnark/relations/ram_computations/rams/tinyram": "default",
        "@libsnark//libsnark/common/routing_algorithms": "default",
        "@libsnark//libsnark/zk_proof_systems/ppzksnark/r1cs_gg_ppzksnark": "default",
        "@libsnark//libsnark/zk_proof_systems/ppzksnark/r1cs_bg_ppzksnark": "default",
        "@libsnark//libsnark/zk_proof_systems/ppzksnark/r1cs_se_ppzksnark": "default",
        "@libsnark//libsnark/relations/constraint_satisfaction_problems/r1cs": "default",

        "@ate_pairing//libzm": "default"
    }
)

ocaml_module(
    name = "election.cm_",
    impl = "election.ml",
    opts = IMPL_OPTS,
    ppx_bin = PPX,
    ppx_bin_opts = PPX_BIN_OPTS,
    visibility = ["//visibility:public"],
    deps = [
        # do not sort (buildifier)
        "//src:snarky",
        ":impl.cm_",
        ":import.cm_",
        ":knapsack_hash.cm_"
    ],
)

ocaml_module(
    name = "election_main.cm_",
    impl = "election_main.ml",
    opts = IMPL_OPTS,
    # + [
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/base",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/bindings",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/cpp_string",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/cpp_vector",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/libsnark_bindings",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/intf",
    # ],
    ppx_bin = PPX,
    ppx_bin_opts = PPX_BIN_OPTS,
    visibility = ["//visibility:public"],
    deps = [
        # do not sort (buildifier)
        "//src:snarky",
        ":election.cm_",
        ":impl.cm_"
    ],
)

ocaml_module(
    name = "impl.cm_",
    impl = "impl.ml",
    opts = IMPL_OPTS,
    # + [
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/base",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/bindings",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/cpp_string",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/cpp_vector",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/camlsnark_c/libsnark_bindings",
    #     "-I", "bazel-out/darwin-fastbuild/bin/src/intf",
    # ],
    ppx_bin = PPX,
    ppx_bin_opts = PPX_BIN_OPTS,
    visibility = ["//visibility:public"],
    deps = [
        # do not sort (buildifier)
        "//src:snarky",
        "//src/base:snarky_backendless",
        "//src/camlsnark_c/libsnark_bindings:snarky_libsnark_bindings",
        "//src/intf:snarky_intf",
    ],
)

ocaml_module(
    name = "import.cm_",
    impl = "import.ml",
    opts = IMPL_OPTS,
    ppx_bin = PPX,
    ppx_bin_opts = PPX_BIN_OPTS,
    visibility = ["//visibility:public"],
    deps = [
        # do not sort (buildifier)
        "//src:snarky",
        ":impl.cm_",
    ],
)

ocaml_interface(
    name = "knapsack_hash.cmi",
    intf = "knapsack_hash.mli",
    # ns_module = ":election_ns_module",
    ppx_bin = PPX,
    ppx_bin_opts = PPX_BIN_OPTS,
    opts = INTF_OPTS,
    deps = [
        # do not sort (buildifier)
        ":impl.cm_",
    ],
)

ocaml_module(
    name = "knapsack_hash.cm_",
    impl = "knapsack_hash.ml",
    cmi  = ":knapsack_hash.cmi",
    opts = IMPL_OPTS,
    ppx_bin = PPX,
    ppx_bin_opts = PPX_BIN_OPTS,
    visibility = ["//visibility:public"],
    deps = [
        # do not sort (buildifier)
        "//src:snarky",
        "//src/base:snarky_backendless",
    ],
)
