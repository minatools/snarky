load("@rules_foreign_cc//tools/build_defs:configure.bzl", "configure_make")

configure_make(
    name = "libgmp",
    configure_env_vars = select({
        "//bzl/host:macos": {
            "AR": "",
            "CXXFLAGS" : "-lc++ -m64 -fomit-frame-pointer", #  -Dredacted",
        },
        "//bzl/host:linux_x64": {
            "CFLAGS" : "-fPIC -DPIC -m64",
            "CXXFLAGS" : "-lstdc++ -m64 -fomit-frame-pointer -fPIC -DPIC",
        },
    }, no_match_error = "libgmp: unsupported platform.  Linux and MacOS only."),
    #     # cross-compile:
    #     # "CPPFLAGS": "-P -fPIC -I$COSYSROOT/usr/local/include -I$COSYSROOT/usr/include",
    #     # "LDFLAGS": "-L$COSYSROOT/usr/lib/x86_64-unknown-linux-gnu",
    # ],
    configure_options = ["--enable-cxx"]
    + select({
        "//bzl/host:linux_x64": [
            "--disable-shared",
            "--enable-static"
        ],
        "//bzl/host:macos": [
            # "--build=x86_64-apple-darwin",
            "AR=\"\"",
            # "-Wl,-no_pie", # avoid PIE disabled warning
            "--enable-shared",
            "--enable-static",
            "--with-pic",
            ## due to the -D stuff Bazel inserts, omission of -Dredacted results in:
            ## error: invalid suffix on literal; C++11 requires a space
            ## between literal and identifier [-Wreserved-user-defined-literal]
            "CFLAGS=-Dredacted",
        ]
    }, no_match_error = "libgmp: unsupported platform.  Linux and MacOS only."),
    lib_source = "@libgmp//:all",
    out_lib_dir = "lib",
    shared_libraries = select({
        "//bzl/host:macos": ["libgmp.dylib", "libgmpxx.dylib"],
        "//bzl/host:linux_x64": [], # "libgmp.so.10.4.0", "libgmpxx.so.4.6.0"],
    }, no_match_error = "libgmp: unsupported platform.  Linux and MacOS only."),
    static_libraries = ["libgmpxx.a", "libgmp.a"],
    visibility = ["//visibility:public"],
)
